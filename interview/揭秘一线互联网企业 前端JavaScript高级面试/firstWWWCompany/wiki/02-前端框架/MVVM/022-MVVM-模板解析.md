## 目录

- 补充：结构化与非结构化
- 模板是什么（以及要如何实现模板的功能，利用 JS 函数）
- 解析模板前提：将模板结构化
- 如何实现结构化 —— htmlparser 演示
- 指令的解析
- 生成 render 函数，以及和 vdom 的关系
- vue 2.0 的预编译

## 补充：结构化与非结构化

先用一节时间讲讲结构化与非结构化。举几个例子：

第一，`JSON.parse` 是将字符串转化为 JS 对象， `JSON.stringify` 是将 JS 对象转换为字符串。对于一个比较复杂的数据，JS 来操作，用字符串形式比较简单？还是用 JS 对象的形式比较简单？—— JS 对象。

因为，JS 对象是一个标准的计算机可识别的数据结构。到这里，你应该能明白为何计算机专业的基础之一是数据结构，以及为何“程序 = 数据结构 + 算法”这个公式。基本数据结构有：树、链表、堆、栈、图等等，基本的算法有：排序、遍历、搜索等等。

字符串是什么数据结构？什么都不沾边。因此操作字符串的 API 非常少，因为它可操作性太小。

（PPT 中截图，字符串和 js 对象两种形式的截图）

> 计算机很傻很天真，远远不及人类聪明，它的好处就两个：听话，给什么指令就执行什么指令，死循环也执行；运算速度快；

第二，浏览器获取以及解析网页，这个过程在《前端 JS 面试技巧》讲过。浏览器能获取到的仅仅是一堆 html 代码而已，你查看一个网页的源码，它就是一堆字符串。而浏览器需要将 html 转换成 dom ，才能结合 css 进行渲染，也才能让 JS API 进行操作。要只有一堆字符串，我们平常使用的各种操作 DOM 的方法，那该怎么实现？

第三，我们网站、app的数据，为何要存储在 mysql 这种关系型数据库（或者现在一些 no-sql 的数据库），而不是一个文件中？就因为数据要结构化。

其实，我们在电脑、手机能看到、操作的任何信息（网页、视频、地图、游戏、word、excel、包括人工智能），用的都是结构化的数据。

总结一下：结构化的数据就是符合计算机基础数据结构，可被计算机操作的数据，如 JS 对象。而非结构化的数据就是不符合计算机基础数据结构，靠操作性非常差的数据，如字符串。


（PPT 中截图，DOM 结构和 html 源码）


> PS：计算机本来就是结构化计算的产物，因此比较好实现。那还有什么是不好结构化的呢？—— 例如管理学。一本管理学的书，分了好多目录、模块、流程，但是真的就像计算机中结构化的那么严格吗？完全不是。但是，为了能让管理学的知识输出到书本中供阅读，那也只能这么做，没有其他办法。**其实，从这个话题可以引申出好多贴近我们生活的例子，中医 vs 西医、肯德基 vs 中式餐馆**

## 模板是什么（以及要如何实现模板的功能，利用 JS 函数）

```html
<div id="app">
    <div>
        <input v-model="title">
        <button v-on:click="add">submit</button>
    </div>
    <ul>
        <li v-for="item in list">{{item}}</li>
    </ul>
</div>
```

- 字符串，是非结构化的
- 有逻辑，如`v-for` `v-if`等指令，是动态的

和 html 对比

- 标签类型相同
- html 是静态，模板是有逻辑的动态的

既然是非结构化的，想要处理，就要先把转化成结构化的数据。

## 解析模板前提：将模板结构化

AST 抽象语法树（Abstract Syntax Tree）

拿一个最简单的模板来说

```html
<div id="app">
    <p>{{price}} 元</p>
</div>
```

转换之后

```js
{
    type: 1,  // 对应 nodeType
    tag: 'div',
    attrs : {id: 'app'},
    children: [
        {
            type: 1,
            tag: 'p',
            attrs: {},
            children: [
                {
                    type: 2,  // text 类型
                    text: '{{price}} 元',
                    expression: '_s(price)+" 元"'
                }
            ]
        }
    ]
}
```

其中`expression: '_s(price)+" 元"'`先预留，后面会讲解

## 如何实现结构化 —— htmlparser 演示

（直接代码演示）

## 指令的解析

模板中

`<p>{{price}} 元</p>`

解析成 AST 对应的部分是

```js
{
    type: 1,
    tag: 'p',
    attrs: {},
    children: [
        {
            type: 2,  // text 类型
            text: '{{price}} 元',
            expression: '_s(price)+" 元"'
        }
    ]
}
```

注意其中的`expression: '_s(price)+" 元"'`。其中`price`是配置 vue 的时候的 data 中的数据，即模板中的`{{price}}`也需要取其中的数据。

```js
var vm = new Vue({
    el: '#div1',
    data: {
        price: 100
    }
})

// 注意，虽然这么配置，但是用以下方式也可以获取 price
// vm.price
```

**思考一个问题：模板就是一个字符串，它如何能够拿到 data 中的 price 呢，或者说通过什么方式能拿到 price 这个数据？—— 好好思考。**

答案其实就在`expression: '_s(price)+" 元"'`中 —— 用 JS 代码即可拿到 price 。其中`'_s(price)+" 元"'`就可以通过`new Function(...)`生成一个 JS 函数，执行这个函数时，其中的`_s`就变成了一个函数，`price`就变成了一个变量。可以模拟一下

```js
var vm = new Vue({
    el: '#div1',
    data: {
        price: 100
    }
})

// 注意，虽然这么配置，但是用以下方式也可以获取 price
// vm.price

vm._s = function (text) {
    // 先模拟一下 _s 函数
    alert(text);
}

function fn() {
    with(vm) {
        return _s(price) + " 元";
    }
}
```

现在知道一开始提到的`expression: '_s(price)+" 元"'`的用意了吧？

- 将模板中的逻辑转换成 js 函数体
- 将模板中的变量转换为真正的 js 变量
- 其实，最终 vue 就是将模板全部转换为一大堆 js 代码，完成蜕变

上述`{{price}}`是生成了`'_s(price)+" 元"'`这样的 JS 代码。那么`v-for` `v-if`等指令，这里就不掩饰了，总之就是生成一些`for`和`if`这些 JS 逻辑代码。**面试的时候，你能把这个过程说出来，面试官基本已经满意了，这部分非常难，面试官不会要求太高。**

总结一下：指令其实就是提前封装的一些 js 逻辑，用比较简单的形式写出来了。用起来很简单，解析起来很复杂。

## 生成 render 函数，以及和 vdom 的关系

- 模板中有指令，是动态的、有逻辑的，必须转换成 JS 代码才能运行 —— 上文讲过
- 模板最终要生成 html （模板不是 html）渲染页面，也只有 JS 能渲染 html 。因此，整个模板都要转换成 JS 代码才行，不光是指令。


另外，模板最终转换为 html ，它是怎么成为 html 的呢？

- 模板先成为 js 函数
- js 函数生成 vnode
- vnode 经过 patch 在成为 html

这样就把 vnode 和模板联系起来了。

还是用这个模板做例子

```html
<div id="app">
    <p>{{price}} 元</p>
</div>
```

模板不能直接生成函数，因为模板是字符串。但是字符串可以转化为另一种字符串

```js
var code = '_c("div", {id: "app"}, [_c("p", {}, [_s(this.price)])])';
var render = new Function(code);
```

这样相当于

```js
render = function () {
    _c('div', {id: 'app'}, [
        _c('p', {}, [
            _s(this.prirce + ' 元')
        ])
    ])
}
```

这样就联想到了 vdom 部分的`h`函数。`_c`就相当于`h`函数，`_s`就是生成 text 节点的函数，跟`h`函数类似。

## 总结

最终，模板生成 render 函数，render 函数执行会返回 vnode 。

为何要生成 render 函数？

- 模板中的指令是有逻辑的，必须通过 js 执行
- 模板要最终生成 html ，也需要 js 来渲染

怎样生成的 render 函数？

- 先将模板结构化
- 结构化过程中解析指令逻辑
- 最终根据结构化的 AST 生成 render 函数

## vue 2.0 的预编译

模板生成 render 函数的这个过程，在开发环境打包的时候就执行好了，而不是在浏览器中执行

