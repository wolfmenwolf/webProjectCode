<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<head>
<title>Ajax 考试系统</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<style>
/* body样式 */
body {
    margin:0;
    background:#DEDBD6;
    font-family:Verdana;
}

/* 字体基本样式 */
body, td {
    font-size:14px;
}

/* 中央表格样式 */
#centertab {
    border: 3px solid #036;
    background:#FFF;
}

/* 段落样式 */
p {
    padding:3px;
    margin:0;
}

/* 按钮样式 */
.btn {
    border-right: #002D96 1px solid;
    padding-right: 5px;
    border-top: #002D96 1px solid;
    padding-left: 5px;
    font-size: 12px;
    filter: progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr=#FFFFFF, EndColorStr=#9DBCEA);
    border-left: #002D96 1px solid;
    cursor: hand;
    color: black;
    padding-top: 3px;
    border-bottom: #002D96 1px solid;
}

/* 成绩样式 */
#score {
    font-size:50px;
    color:#F00;
}

/* 问题标题样式 */
#quesTitle {
    font-weight:bold;
    padding:5px;
}

/* 问题编号样式 */
#quesNum {
    font-family:Arial;
    padding:5px;
    color:#036;
}

/* 填空样式 */
.blank {
    font-size:12px;
    width:80px;
    margin-left:5px;
    margin-right:5px;
}

/* 欢迎信息样式 */
#welcome {
    text-align:center;
    line-height:100px;
    color:#060;
}
</style>
<script type="text/javascript">
var xmlHttp;                //用于保存XMLHttpRequest对象的全局变量
var questionCount = 0;      //试题记数器
var rightCount = 0;         //正确作答计数器

var currQuestion;           //保存当前试题
var totalQuestionNum = -1;  //试题总数

var agt = navigator.userAgent.toLowerCase();            //客户端浏览器信息
var isIE = (agt.indexOf("msie")!=-1 && document.all);   //判断是否是IE浏览器

//用于创建XMLHttpRequest对象
function createXmlHttp() {
    //根据window.XMLHttpRequest对象是否存在使用不同的创建方式
    if (window.XMLHttpRequest) {
       xmlHttp = new XMLHttpRequest();                  //FireFox、Opera等浏览器支持的创建方式
    } else {
       xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");//IE浏览器支持的创建方式
    }
}

//开始考试
function startExam() {
    createXmlHttp();                                            //创建XmlHttpRequest对象
    xmlHttp.onreadystatechange = handleStartExamStateChange;    //设置回调函数
    xmlHttp.open("GET", "question.jsp?start=true", true);
    xmlHttp.send(null);
}

//处理开始考试响应
function handleStartExamStateChange() {
    if(xmlHttp.readyState == 4) {
        if(xmlHttp.status == 200) {
            document.getElementById("welcome").style.display="none";    //隐藏欢迎信息
            var result = xmlHttp.responseText;                          //获取总题数
            totalQuestionNum = Number(result);                          //记录总题数
            getNextQuestion();                                          //获取第一道试题
            setButtonStatus(0,1,0);                                     //设置按钮为“下一题”
        }
    }
}

//获取下一道试题
function getNextQuestion() {
    createXmlHttp();                                            //创建XmlHttpRequest对象
    xmlHttp.onreadystatechange = handleNextQuestionStateChange; //设置回调函数
    xmlHttp.open("GET", "question.jsp?get="+questionCount, true);
    xmlHttp.send(null);
}

//处理获取试题响应
function handleNextQuestionStateChange() {
    if(xmlHttp.readyState == 4) {
        if(xmlHttp.status == 200) {
            questionCount++;                //试题记数增加
            showQuestion();                 //显示试题
        }
    }
}

//显示试题
function showQuestion() {
    var xmlDoc = xmlHttp.responseXML;                   //获取试题信息
    currQuestion = convertXmlDoc2QuestionObj(xmlDoc);   //转换XmlDoc为Question对象

    //显示试题记数信息
    var qn = document.getElementById("quesNum");
    qn.innerHTML = questionCount + " / " + totalQuestionNum + " 【" + getCurrQuesType() + "】";

    //显示试题信息
    var title = xmlDoc.getElementsByTagName("title");
    var quesTitle = document.getElementById("quesTitle");
    quesTitle.appendChild(getItemTextNode(title[0]));

    //获取选项信息
    var qOptions = xmlDoc.getElementsByTagName("option");
    var quesOptions = document.getElementById("quesOptions");

    //处理有选项的试题
    if (currQuestion.type < "4") {
        for(var i = 0; i < qOptions.length; i++) {
            quesOptions.appendChild(createOption(qOptions[i]));
        }
    //处理填空题
    } else {
        quesTitle.innerHTML = currQuestion.title.replace(/\$__\$/g,"<input type='text' name='"+currQuestion.id+"' class='blank'/>");
    }
}

//转换xmlDoc到Question对象
function convertXmlDoc2QuestionObj(xmlDoc) {
    var qObj = new Object();                //新建一个对象保存question
    //设置标题
    qObj.title = xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue;

    var _question = xmlDoc.getElementsByTagName("question")[0];

    qObj.type = _question.getAttribute("type");     //设置类型
    qObj.id = _question.getAttribute("id");         //设置编号
    return qObj;
}

//创建每个选项
function createOption(item) {
    var pNode = document.createElement("p");        //创建一个p节点
    var qOptionNode = getItemTextNode(item);        //创建选项文本
    var qOptionValue = qOptionNode.nodeValue;       //创建选项值

    //根据试题类型设置inputType
    var inputType = "radio";
    if (currQuestion.type == "2") {
        inputType = "checkbox";
    }

    //根据不同浏览器创建选项节点
    var itemOption;
    //IE浏览器
    if (isIE) {
        itemOption = document.createElement("<input type='"+inputType+"' name='"+currQuestion.id+"' value='"+qOptionValue+"' />");
    //其它浏览器
    } else {
        itemOption = document.createElement("input");
        itemOption.setAttribute("type", inputType);
        itemOption.setAttribute("name", currQuestion.id);
        itemOption.setAttribute("value", qOptionValue);
    }

    pNode.appendChild(itemOption);                  //追加选项节点
    pNode.appendChild(qOptionNode);                 //追加选项文本
    return pNode;
}

//创建文本节点
function getItemTextNode(item) {
    return document.createTextNode(item.childNodes[0].nodeValue)
}

//提交并清除当前试题
function submitCurrQuestion() {
    var url = "answer.jsp?timeStamp=" + new Date().getTime();   //使用timeStamp防止浏览器缓存
    var queryString = createQueryString();                      //创建参数体

    createXmlHttp();                                            //创建XmlHttpRequest对象
    xmlHttp.open("POST", url, true);                            //发送POST请求
    xmlHttp.onreadystatechange = handleSubmitStateChange;       //设置回调函数

    xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");
    xmlHttp.send(queryString);                                  //发送参数体

    //清空标题内容
    var quesTitle = document.getElementById("quesTitle");
    while (quesTitle.hasChildNodes()) {
        quesTitle.removeChild(quesTitle.childNodes[0]);
    }

    //清空选项内容
    var quesOptions = document.getElementById("quesOptions");
    while (quesOptions.childNodes.length > 0) {
        quesOptions.removeChild(quesOptions.childNodes[0]);
    }
}

//处理提交答案请求
function handleSubmitStateChange() {
    if(xmlHttp.readyState == 4) {
        if(xmlHttp.status == 200) {
            var result = xmlHttp.responseText;  //获取服务器响应
            //如果答对了，正确计数器加1
            if (result.indexOf("RIGHT")!=-1) {
                rightCount++;
            }
            //如果所有试题都答完，统计成绩
            if (questionCount==totalQuestionNum) {
                document.getElementById("quesNum").innerHTML = "";
                var qo = document.getElementById("quesOptions");
                qo.style.textAlign="center";
                qo.innerHTML = "<div>共 " + totalQuestionNum +
                               " 题，答对 " + rightCount +
                               " 题，成绩：</div><div id='score'>" +
                               Math.round(rightCount/totalQuestionNum*1000)/10 +
                               "</div>";
                setButtonStatus(0,0,1);         //设置按钮为“重新开始”
            } else {
                getNextQuestion();              //获取下一道试题
            }
        }
    }
}

//将用户作答情况汇总为参数字符串
function createQueryString() {
    var queryString = "questionId="+currQuestion.id;
    var answers = document.getElementsByName(currQuestion.id);
    //根据题类型不同进行对应的汇总
    if (currQuestion.type < 4) {    //非填空题
        for (var i=0; i<answers.length; i++) {
            if (answers[i].checked==true) {
                queryString = queryString + "&answer=" + encodeURIComponent(answers[i].value);
            }
        }
    } else {                        //填空题
        for (var i=0; i<answers.length; i++) {
            queryString = queryString + "&answer=" + encodeURIComponent(answers[i].value);
        }
    }
    return queryString;
}

//重新开始考试
function restart() {
    //确认重新开始后执行初始化操作
    if (confirm("确定重新开始考试？")) {
        //初始化问题标题
        var quesTitle = document.getElementById("quesTitle");
        while (quesTitle.hasChildNodes()) {
            quesTitle.removeChild(quesTitle.childNodes[0]);
        }

        //初始化问题选项
        var quesOptions = document.getElementById("quesOptions");
        quesOptions.style.textAlign="left";
        while (quesOptions.childNodes.length > 0) {
            quesOptions.removeChild(quesOptions.childNodes[0]);
        }

        document.getElementById("welcome").style.display = "";  //显示欢迎信息
        questionCount = 0;                                      //试题记数器清零
        rightCount = 0;                                         //正确作答计数器清零

        currQuestion = null;                                    //保存当前试题
        totalQuestionNum = -1;                                  //试题总数初始化
        setButtonStatus(1,0,0);                                 //设置按钮为“开始考试”
    }
}

//处理三个按钮的显示情况
function setButtonStatus(a,b,c) {
    var btn1 = document.getElementById("startExamBtn");     //“开始考试”
    var btn2 = document.getElementById("submitQuesBtn");    //“下一题”
    var btn3 = document.getElementById("restartBtn");       //“重新开始”
    if (a==1) {
        btn1.style.display = "";
    } else {
        btn1.style.display = "none";
    }
    if (b==1) {
        btn2.style.display = "";
    } else {
        btn2.style.display = "none";
    }
    if (c==1) {
        btn3.style.display = "";
    } else {
        btn3.style.display = "none";
    }
}

//获取当前试题类型中文名称
function getCurrQuesType() {
    switch (currQuestion.type) {
        case "1" : return "单选";
        case "2" : return "多选";
        case "3" : return "判断";
        case "4" : return "填空";
        default : return "未知";
    }
}
</script>
</head>

<body onload="createXmlHttp()">
<table border="0" height="100%" width="100%" cellpadding="0" cellspacing="0">
<tr>
    <td valign="middle" align="center" height="100%" width="100%">
    <table border="0" height="400px" width="640px" cellpadding="0" cellspacing="0" id="centertab">
    <tr>
        <td align="center" height="50px" style="font-size:16px;letter-spacing:2px;background:#036;color:#fff" valign="middle">
        Ajax 考试系统
        </td>
    </tr>
    <tr>
        <td height="*" valign="top" style="padding:15px">
        <div id="quesNum"></div>
        <div id="quesTitle"></div>
        <div id="quesOptions" style="text-align:left"></div>
        <div id="welcome">欢迎使用本考试系统，点击下方的【开始考试】按钮进行考试。</div>
        </td>
    </tr>
    <tr>
        <td height="30px" valign="middle" align="center" style="border-top:1px solid #036;background:#036;">
            <input type="button" id="startExamBtn" value="开始考试" onclick="startExam();" class="btn" />
            <input type="button" id="submitQuesBtn" value="下一题" onclick="submitCurrQuestion();" class="btn" style="display:none" />
            <input type="button" id="restartBtn" value="重新开始" onclick="restart();" class="btn" style="display:none" />
        </td>
    </tr>
    </table>
    </td>
</tr>
</table>
</body>
</html>